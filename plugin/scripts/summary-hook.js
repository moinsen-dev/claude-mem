#!/usr/bin/env node
import{stdin as X}from"process";function q(r,t,e){return r==="SessionStart"?t&&e.context?{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"SessionStart",additionalContext:e.context}}:{continue:!0,suppressOutput:!0}:r==="UserPromptSubmit"||r==="PostToolUse"?{continue:!0,suppressOutput:!0}:r==="Stop"?{continue:!0,suppressOutput:!0}:{continue:t,suppressOutput:!0,...e.reason&&!t?{stopReason:e.reason}:{}}}function P(r,t,e={}){let n=q(r,t,e);return JSON.stringify(n)}import{createHash as ot}from"crypto";import{readFileSync as Z,writeFileSync as tt,existsSync as et}from"fs";import{join as rt}from"path";import{homedir as nt}from"os";var J=["bugfix","feature","refactor","discovery","decision","change"],z=["how-it-works","why-it-exists","what-changed","problem-solution","gotcha","pattern","trade-off"];var H=J.join(","),x=z.join(",");var _=class{static DEFAULTS={CLAUDE_MEM_MODEL:"claude-haiku-4-5",CLAUDE_MEM_CONTEXT_OBSERVATIONS:"50",CLAUDE_MEM_WORKER_PORT:"37777",CLAUDE_MEM_SKIP_TOOLS:"ListMcpResourcesTool,SlashCommand,Skill,TodoWrite,AskUserQuestion",CLAUDE_MEM_DATA_DIR:rt(nt(),".claude-mem"),CLAUDE_MEM_LOG_LEVEL:"INFO",CLAUDE_MEM_PYTHON_VERSION:"3.13",CLAUDE_CODE_PATH:"",CLAUDE_MEM_CONTEXT_SHOW_READ_TOKENS:"true",CLAUDE_MEM_CONTEXT_SHOW_WORK_TOKENS:"true",CLAUDE_MEM_CONTEXT_SHOW_SAVINGS_AMOUNT:"true",CLAUDE_MEM_CONTEXT_SHOW_SAVINGS_PERCENT:"true",CLAUDE_MEM_CONTEXT_OBSERVATION_TYPES:H,CLAUDE_MEM_CONTEXT_OBSERVATION_CONCEPTS:x,CLAUDE_MEM_CONTEXT_FULL_COUNT:"5",CLAUDE_MEM_CONTEXT_FULL_FIELD:"narrative",CLAUDE_MEM_CONTEXT_SESSION_COUNT:"10",CLAUDE_MEM_CONTEXT_SHOW_LAST_SUMMARY:"true",CLAUDE_MEM_CONTEXT_SHOW_LAST_MESSAGE:"false",CLAUDE_MEM_SLACK_ENABLED:"false",CLAUDE_MEM_SLACK_BOT_TOKEN:"",CLAUDE_MEM_SLACK_APP_TOKEN:"",CLAUDE_MEM_SLACK_CHANNEL_ID:"",CLAUDE_MEM_SLACK_NOTIFY_ON_QUESTIONS:"true",CLAUDE_MEM_SLACK_SESSION_EXPIRY_HOURS:"24",CLAUDE_MEM_INTERACTION_MODE:"auto",CLAUDE_MEM_SLACK_SHARE_SUMMARIES:"false",CLAUDE_MEM_SLACK_SHARE_TYPES:""};static getAllDefaults(){return{...this.DEFAULTS}}static get(t){return this.DEFAULTS[t]}static getInt(t){let e=this.get(t);return parseInt(e,10)}static getBool(t){return this.get(t)==="true"}static loadFromFile(t){if(!et(t))return this.getAllDefaults();let e=Z(t,"utf-8"),n=JSON.parse(e),o=n;if(n.env&&typeof n.env=="object"){o=n.env;try{tt(t,JSON.stringify(o,null,2),"utf-8"),c.info("SETTINGS","Migrated settings file from nested to flat schema",{settingsPath:t})}catch(i){c.warn("SETTINGS","Failed to auto-migrate settings file",{settingsPath:t},i)}}let s={...this.DEFAULTS};for(let i of Object.keys(this.DEFAULTS))o[i]!==void 0&&(s[i]=o[i]);return s}};var S=(s=>(s[s.DEBUG=0]="DEBUG",s[s.INFO=1]="INFO",s[s.WARN=2]="WARN",s[s.ERROR=3]="ERROR",s[s.SILENT=4]="SILENT",s))(S||{}),A=class{level=null;useColor;dbSink=null;logBuffer=[];flushTimer=null;bufferSize=50;flushIntervalMs=5e3;isInitialized=!1;constructor(){this.useColor=process.stdout.isTTY??!1}initializeDatabaseSink(t){this.isInitialized||(this.dbSink=t,this.isInitialized=!0,this.flushTimer=setInterval(()=>this.flushBuffer(),this.flushIntervalMs),process.on("beforeExit",()=>this.flushBuffer()),process.on("SIGINT",()=>{this.flushBuffer(),process.exit(0)}),process.on("SIGTERM",()=>{this.flushBuffer(),process.exit(0)}))}get isDatabaseLoggingEnabled(){return this.dbSink!==null}flushBuffer(){if(this.logBuffer.length===0||!this.dbSink)return;let t=[...this.logBuffer];this.logBuffer=[];try{this.dbSink.storeSystemLogBatch(t)}catch{console.error("[Logger] Failed to flush logs to database")}}createErrorHash(t,e){let n=t.replace(/\d{4}-\d{2}-\d{2}[T\s]\d{2}:\d{2}:\d{2}/g,"TIMESTAMP").replace(/\b\d+\b/g,"NUM").replace(/\/[\w\/.-]+/g,"PATH").substring(0,200);return ot("md5").update(`${e}:${n}`).digest("hex").substring(0,16)}getLevel(){if(this.level===null){let t=_.get("CLAUDE_MEM_LOG_LEVEL").toUpperCase();this.level=S[t]??1}return this.level}correlationId(t,e){return`obs-${t}-${e}`}sessionId(t){return`session-${t}`}formatData(t){if(t==null)return"";if(typeof t=="string")return t;if(typeof t=="number"||typeof t=="boolean")return t.toString();if(typeof t=="object"){if(t instanceof Error)return this.getLevel()===0?`${t.message}
${t.stack}`:t.message;if(Array.isArray(t))return`[${t.length} items]`;let e=Object.keys(t);return e.length===0?"{}":e.length<=3?JSON.stringify(t):`{${e.length} keys: ${e.slice(0,3).join(", ")}...}`}return String(t)}formatTool(t,e){if(!e)return t;try{let n=typeof e=="string"?JSON.parse(e):e;if(t==="Bash"&&n.command){let o=n.command.length>50?n.command.substring(0,50)+"...":n.command;return`${t}(${o})`}if(t==="Read"&&n.file_path){let o=n.file_path.split("/").pop()||n.file_path;return`${t}(${o})`}if(t==="Edit"&&n.file_path){let o=n.file_path.split("/").pop()||n.file_path;return`${t}(${o})`}if(t==="Write"&&n.file_path){let o=n.file_path.split("/").pop()||n.file_path;return`${t}(${o})`}return t}catch{return t}}log(t,e,n,o,s){if(t<this.getLevel())return;let i=new Date,a=i.toISOString().replace("T"," ").substring(0,23),f=S[t].padEnd(5),p=e.padEnd(6),E="";o?.correlationId?E=`[${o.correlationId}] `:o?.sessionId&&(E=`[session-${o.sessionId}] `);let O="";s!=null&&(this.getLevel()===0&&typeof s=="object"?O=`
`+JSON.stringify(s,null,2):O=" "+this.formatData(s));let N="";if(o){let{sessionId:U,sdkSessionId:T,correlationId:k,...b}=o;Object.keys(b).length>0&&(N=` {${Object.entries(b).map(([Y,V])=>`${Y}=${V}`).join(", ")}}`)}let I=`[${a}] [${f}] [${p}] ${E}${n}${N}${O}`;if(t===3?console.error(I):console.log(I),this.dbSink&&t>=1){let U=S[t],T;if(s instanceof Error&&(T=s.stack),this.logBuffer.push({level:U,component:e,message:n,context:o?{...o}:void 0,data:s instanceof Error?{message:s.message,name:s.name}:s,errorStack:T,timestamp:i}),t===3&&this.dbSink){let k=this.createErrorHash(n,e);try{this.dbSink.trackErrorPattern(k,n,e)}catch{}}this.logBuffer.length>=this.bufferSize&&this.flushBuffer()}}debug(t,e,n,o){this.log(0,t,e,n,o)}info(t,e,n,o){this.log(1,t,e,n,o)}warn(t,e,n,o){this.log(2,t,e,n,o)}error(t,e,n,o){this.log(3,t,e,n,o)}dataIn(t,e,n,o){this.info(t,`\u2192 ${e}`,n,o)}dataOut(t,e,n,o){this.info(t,`\u2190 ${e}`,n,o)}success(t,e,n,o){this.info(t,`\u2713 ${e}`,n,o)}failure(t,e,n,o){this.error(t,`\u2717 ${e}`,n,o)}timing(t,e,n,o){this.info(t,`\u23F1 ${e}`,o,{duration:`${n}ms`})}},c=new A;import u from"path";import{existsSync as d,readdirSync as st}from"fs";import{homedir as M}from"os";import{spawnSync as L}from"child_process";var g={DEFAULT:5e3,HEALTH_CHECK:1e3,WORKER_STARTUP_WAIT:1e3,WORKER_STARTUP_RETRIES:15,WINDOWS_MULTIPLIER:1.5};function v(r){return process.platform==="win32"?Math.round(r*g.WINDOWS_MULTIPLIER):r}var l=u.join(M(),".claude","plugins","marketplaces","thedotmack"),C=u.join(M(),".claude","plugins","cache","thedotmack","claude-mem");function m(){try{if(!d(C))return null;let r=st(C).filter(t=>/^\d+\.\d+\.\d+$/.test(t)).sort((t,e)=>{let[n,o,s]=t.split(".").map(Number),[i,a,f]=e.split(".").map(Number);return n!==i?i-n:o!==a?a-o:f-s});return r.length>0?u.join(C,r[0]):null}catch{return null}}function it(){let r=m();if(r){let n=u.join(r,"node_modules",".bin","pm2");if(d(n))return{command:n,cwd:r}}let t=u.join(l,"node_modules",".bin","pm2");return d(t)?{command:t,cwd:l}:L("which",["pm2"],{encoding:"utf-8",stdio:"pipe"}).status===0?{command:"pm2",cwd:l}:null}function $(){let r=m();if(r){let e=u.join(r,"scripts","worker-service.cjs");if(d(e))return{script:e,cwd:r}}let t=u.join(l,"plugin","scripts","worker-service.cjs");return d(t)?{script:t,cwd:l}:null}function W(){let r=m();if(r){let e=u.join(r,"ecosystem.config.cjs");if(d(e))return{configPath:e,cwd:r}}let t=u.join(l,"ecosystem.config.cjs");return d(t)?{configPath:t,cwd:l}:null}var at=v(g.HEALTH_CHECK),ct=g.WORKER_STARTUP_WAIT,lt=g.WORKER_STARTUP_RETRIES;function h(){let r=u.join(M(),".claude-mem","settings.json"),t=_.loadFromFile(r);return parseInt(t.CLAUDE_MEM_WORKER_PORT,10)}async function y(){try{let r=h();return(await fetch(`http://127.0.0.1:${r}/health`,{signal:AbortSignal.timeout(at)})).ok}catch(r){return c.debug("SYSTEM","Worker health check failed",{error:r instanceof Error?r.message:String(r),errorType:r?.constructor?.name}),!1}}async function ut(){try{let r=$();if(!r)throw new Error("Worker script not found in cache or marketplace directory");let{script:t,cwd:e}=r;if(process.platform==="win32"){let n=t.replace(/'/g,"''"),o=e.replace(/'/g,"''"),s=L("powershell.exe",["-NoProfile","-NonInteractive","-Command",`Start-Process -FilePath 'node' -ArgumentList '${n}' -WorkingDirectory '${o}' -WindowStyle Hidden`],{cwd:e,stdio:"pipe",encoding:"utf-8",windowsHide:!0});if(s.status!==0)throw new Error(s.stderr||"PowerShell Start-Process failed")}else{let n=W();if(!n)throw new Error("Ecosystem config not found");let o=it();if(!o){let i=m();throw new Error(`PM2 not found. Install it locally with:
  cd ${i||l}
  npm install

Or install globally with: npm install -g pm2`)}let s=L(o.command,["start",n.configPath],{cwd:n.cwd,stdio:"pipe",encoding:"utf-8"});if(s.status!==0)throw new Error(s.stderr||"PM2 start failed")}for(let n=0;n<lt;n++)if(await new Promise(o=>setTimeout(o,ct)),await y())return!0;return!1}catch(r){let t=$();return c.error("SYSTEM","Failed to start worker",{platform:process.platform,workerScript:t?.script||"not found",error:r instanceof Error?r.message:String(r),cacheDir:m(),marketplaceRoot:l}),!1}}async function K(){if(await y())return;let r=await ut();if(!(!r&&await y())&&!r){let t=h(),e=W(),n=e?.cwd||m()||l,o=e?.configPath||u.join(l,"ecosystem.config.cjs");throw new Error(`Worker service failed to start on port ${t}.

To start manually, run:
  cd ${n}
  npx pm2 start ${o}

If already running, try: npx pm2 restart claude-mem-worker`)}}import{appendFileSync as ft}from"fs";import{homedir as pt}from"os";import{join as Et}from"path";var gt=Et(pt(),".claude-mem","silent.log");function F(r,t,e=""){let n=new Date().toISOString(),a=((new Error().stack||"").split(`
`)[2]||"").match(/at\s+(?:.*\s+)?\(?([^:]+):(\d+):(\d+)\)?/),f=a?`${a[1].split("/").pop()}:${a[2]}`:"unknown",p=`[${n}] [HAPPY-PATH-ERROR] [${f}] ${r}`;if(t!==void 0)try{p+=` ${JSON.stringify(t)}`}catch(E){p+=` [stringify error: ${E}]`}p+=`
`;try{ft(gt,p)}catch(E){console.error("[silent-debug] Failed to write to log:",E)}return e}function B(r){throw r.cause?.code==="ECONNREFUSED"||r.name==="TimeoutError"||r.message?.includes("fetch failed")?new Error("There's a problem with the worker. If you just updated, type `pm2 restart claude-mem-worker` in your terminal to continue"):r}import{readFileSync as dt,existsSync as _t}from"fs";function R(r,t,e=!1){if(!r||!_t(r))return"";try{let n=dt(r,"utf-8").trim();if(!n)return"";let o=n.split(`
`);for(let s=o.length-1;s>=0;s--)try{let i=JSON.parse(o[s]);if(i.type===t&&i.message?.content){let a="",f=i.message.content;return typeof f=="string"?a=f:Array.isArray(f)&&(a=f.filter(p=>p.type==="text").map(p=>p.text).join(`
`)),e&&(a=a.replace(/<system-reminder>[\s\S]*?<\/system-reminder>/g,""),a=a.replace(/\n{3,}/g,`

`).trim()),a}}catch{continue}}catch(n){c.error("HOOK","Failed to read transcript",{transcriptPath:r},n)}return""}var D=["would you like","should i","do you want","shall i","what do you think","what would you prefer","how would you like","which option","which approach","let me know","please confirm","please let me know","can you clarify","could you clarify","can you provide","could you provide","what is your","what are your","is this what you","does this look","does this look correct","does this look right","does this seem correct","is that correct","is this correct","ready to proceed","want me to","like me to","prefer that i"],mt=["done","complete","completed","finished","successfully","all set","ready to use","implemented","created","updated","fixed","resolved","deployed","committed","pushed","merged","installed","configured"],j=["approve the edit","approve this edit","approve the change","approve this change","permission to write","permission to edit","permission to modify","permission to delete","permission to create","grant write permission","grant permission","need permission","need your permission","allow me to","allow this edit","allow this change","can i edit","can i write","can i modify","may i edit","may i write","may i modify"];function St(r){let t=r.split(/(?<=[.!?])\s+/);for(let e=t.length-1;e>=0;e--){let n=t[e].trim();if(n.endsWith("?"))return n}for(let e=t.length-1;e>=Math.max(0,t.length-3);e--){let n=t[e].trim().toLowerCase();for(let o of D)if(n.includes(o))return t[e].trim()}return null}function Q(r){if(!r||r.trim().length===0)return{isQuestion:!1,confidence:"high",extractedQuestion:null,reason:"Empty message"};let t=r.toLowerCase();for(let a of j)if(t.includes(a))return{isQuestion:!1,confidence:"high",extractedQuestion:null,reason:`Permission/tool prompt detected: "${a}" - should be answered locally`};let n=(r.split(`

`).pop()||r).toLowerCase(),o=0;for(let a of mt)n.includes(a)&&o++;let s=0,i=St(r);r.trim().endsWith("?")&&(s+=3);for(let a of D)t.includes(a)&&s++;return s>=3&&o===0?{isQuestion:!0,confidence:"high",extractedQuestion:i,reason:"Message ends with question mark and contains question phrases"}:s>=2&&o<=1?{isQuestion:!0,confidence:"medium",extractedQuestion:i,reason:"Message contains multiple question indicators"}:s>=1&&o===0?{isQuestion:!0,confidence:"low",extractedQuestion:i,reason:"Message contains question indicator without completion phrases"}:o>=2?{isQuestion:!1,confidence:"high",extractedQuestion:null,reason:"Message contains completion phrases indicating task is done"}:{isQuestion:!1,confidence:"medium",extractedQuestion:null,reason:"No clear question indicators found"}}function G(r){if(!r)return!1;let t=r.toLowerCase();for(let e of j.slice(0,5))if(t.includes(e))return!1;if(r.trim().endsWith("?"))return!0;for(let e of D.slice(0,10))if(t.includes(e))return!0;return!1}async function ht(r){if(await K(),!r)throw new Error("summaryHook requires input");let{session_id:t}=r,e=h(),n=F("Missing transcript_path in Stop hook input",{session_id:t},r.transcript_path||""),o=R(n,"user"),s=R(n,"assistant",!0);if(c.dataIn("HOOK","Stop: Requesting summary",{workerPort:e,hasLastUserMessage:!!o,hasLastAssistantMessage:!!s}),s&&G(s)){let i=Q(s);i.isQuestion&&i.confidence!=="low"&&(c.info("HOOK","Question detected, notifying worker",{confidence:i.confidence,hasExtractedQuestion:!!i.extractedQuestion}),fetch(`http://127.0.0.1:${e}/api/sessions/waiting`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({claudeSessionId:t,project:r.cwd.split("/").pop()||"unknown",cwd:r.cwd,question:i.extractedQuestion,fullMessage:s,transcriptPath:n}),signal:AbortSignal.timeout(5e3)}).catch(a=>{c.warn("HOOK","Failed to notify waiting session",{error:a.message})}))}try{let i=await fetch(`http://127.0.0.1:${e}/api/sessions/summarize`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({claudeSessionId:t,last_user_message:o,last_assistant_message:s}),signal:AbortSignal.timeout(g.DEFAULT)});if(!i.ok){let a=await i.text();throw c.failure("HOOK","Failed to generate summary",{status:i.status},a),new Error(`Failed to request summary from worker: ${i.status} ${a}`)}c.debug("HOOK","Summary request sent successfully")}catch(i){B(i)}finally{try{let i=await fetch(`http://127.0.0.1:${e}/api/processing`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({isProcessing:!1}),signal:AbortSignal.timeout(2e3)});i.ok||c.warn("HOOK","Failed to stop spinner",{status:i.status})}catch(i){c.warn("HOOK","Could not stop spinner",{error:i.message})}}console.log(P("Stop",!0))}var w="";X.on("data",r=>w+=r);X.on("end",async()=>{let r=w?JSON.parse(w):void 0;await ht(r)});
