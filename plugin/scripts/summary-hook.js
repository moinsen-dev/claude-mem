#!/usr/bin/env node
import{stdin as j}from"process";function X(e,t,r){return e==="SessionStart"?t&&r.context?{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"SessionStart",additionalContext:r.context}}:{continue:!0,suppressOutput:!0}:e==="UserPromptSubmit"||e==="PostToolUse"?{continue:!0,suppressOutput:!0}:e==="Stop"?{continue:!0,suppressOutput:!0}:{continue:t,suppressOutput:!0,...r.reason&&!t?{stopReason:r.reason}:{}}}function U(e,t,r={}){let n=X(e,t,r);return JSON.stringify(n)}import{readFileSync as G,writeFileSync as q,existsSync as J}from"fs";import{join as z}from"path";import{homedir as Z}from"os";var Y=["bugfix","feature","refactor","discovery","decision","change"],V=["how-it-works","why-it-exists","what-changed","problem-solution","gotcha","pattern","trade-off"];var I=Y.join(","),k=V.join(",");var m=class{static DEFAULTS={CLAUDE_MEM_MODEL:"claude-haiku-4-5",CLAUDE_MEM_CONTEXT_OBSERVATIONS:"50",CLAUDE_MEM_WORKER_PORT:"37777",CLAUDE_MEM_SKIP_TOOLS:"ListMcpResourcesTool,SlashCommand,Skill,TodoWrite,AskUserQuestion",CLAUDE_MEM_DATA_DIR:z(Z(),".claude-mem"),CLAUDE_MEM_LOG_LEVEL:"INFO",CLAUDE_MEM_PYTHON_VERSION:"3.13",CLAUDE_CODE_PATH:"",CLAUDE_MEM_CONTEXT_SHOW_READ_TOKENS:"true",CLAUDE_MEM_CONTEXT_SHOW_WORK_TOKENS:"true",CLAUDE_MEM_CONTEXT_SHOW_SAVINGS_AMOUNT:"true",CLAUDE_MEM_CONTEXT_SHOW_SAVINGS_PERCENT:"true",CLAUDE_MEM_CONTEXT_OBSERVATION_TYPES:I,CLAUDE_MEM_CONTEXT_OBSERVATION_CONCEPTS:k,CLAUDE_MEM_CONTEXT_FULL_COUNT:"5",CLAUDE_MEM_CONTEXT_FULL_FIELD:"narrative",CLAUDE_MEM_CONTEXT_SESSION_COUNT:"10",CLAUDE_MEM_CONTEXT_SHOW_LAST_SUMMARY:"true",CLAUDE_MEM_CONTEXT_SHOW_LAST_MESSAGE:"false",CLAUDE_MEM_SLACK_ENABLED:"false",CLAUDE_MEM_SLACK_BOT_TOKEN:"",CLAUDE_MEM_SLACK_APP_TOKEN:"",CLAUDE_MEM_SLACK_CHANNEL_ID:"",CLAUDE_MEM_SLACK_NOTIFY_ON_QUESTIONS:"true",CLAUDE_MEM_SLACK_SESSION_EXPIRY_HOURS:"24",CLAUDE_MEM_INTERACTION_MODE:"auto",CLAUDE_MEM_SLACK_SHARE_SUMMARIES:"false",CLAUDE_MEM_SLACK_SHARE_TYPES:""};static getAllDefaults(){return{...this.DEFAULTS}}static get(t){return this.DEFAULTS[t]}static getInt(t){let r=this.get(t);return parseInt(r,10)}static getBool(t){return this.get(t)==="true"}static loadFromFile(t){if(!J(t))return this.getAllDefaults();let r=G(t,"utf-8"),n=JSON.parse(r),o=n;if(n.env&&typeof n.env=="object"){o=n.env;try{q(t,JSON.stringify(o,null,2),"utf-8"),c.info("SETTINGS","Migrated settings file from nested to flat schema",{settingsPath:t})}catch(i){c.warn("SETTINGS","Failed to auto-migrate settings file",{settingsPath:t},i)}}let s={...this.DEFAULTS};for(let i of Object.keys(this.DEFAULTS))o[i]!==void 0&&(s[i]=o[i]);return s}};var O=(s=>(s[s.DEBUG=0]="DEBUG",s[s.INFO=1]="INFO",s[s.WARN=2]="WARN",s[s.ERROR=3]="ERROR",s[s.SILENT=4]="SILENT",s))(O||{}),h=class{level=null;useColor;constructor(){this.useColor=process.stdout.isTTY??!1}getLevel(){if(this.level===null){let t=m.get("CLAUDE_MEM_LOG_LEVEL").toUpperCase();this.level=O[t]??1}return this.level}correlationId(t,r){return`obs-${t}-${r}`}sessionId(t){return`session-${t}`}formatData(t){if(t==null)return"";if(typeof t=="string")return t;if(typeof t=="number"||typeof t=="boolean")return t.toString();if(typeof t=="object"){if(t instanceof Error)return this.getLevel()===0?`${t.message}
${t.stack}`:t.message;if(Array.isArray(t))return`[${t.length} items]`;let r=Object.keys(t);return r.length===0?"{}":r.length<=3?JSON.stringify(t):`{${r.length} keys: ${r.slice(0,3).join(", ")}...}`}return String(t)}formatTool(t,r){if(!r)return t;try{let n=typeof r=="string"?JSON.parse(r):r;if(t==="Bash"&&n.command){let o=n.command.length>50?n.command.substring(0,50)+"...":n.command;return`${t}(${o})`}if(t==="Read"&&n.file_path){let o=n.file_path.split("/").pop()||n.file_path;return`${t}(${o})`}if(t==="Edit"&&n.file_path){let o=n.file_path.split("/").pop()||n.file_path;return`${t}(${o})`}if(t==="Write"&&n.file_path){let o=n.file_path.split("/").pop()||n.file_path;return`${t}(${o})`}return t}catch{return t}}log(t,r,n,o,s){if(t<this.getLevel())return;let i=new Date().toISOString().replace("T"," ").substring(0,23),a=O[t].padEnd(5),f=r.padEnd(6),l="";o?.correlationId?l=`[${o.correlationId}] `:o?.sessionId&&(l=`[session-${o.sessionId}] `);let E="";s!=null&&(this.getLevel()===0&&typeof s=="object"?E=`
`+JSON.stringify(s,null,2):E=" "+this.formatData(s));let R="";if(o){let{sessionId:dt,sdkSessionId:mt,correlationId:gt,...N}=o;Object.keys(N).length>0&&(R=` {${Object.entries(N).map(([Q,B])=>`${Q}=${B}`).join(", ")}}`)}let D=`[${i}] [${a}] [${f}] ${l}${n}${R}${E}`;t===3?console.error(D):console.log(D)}debug(t,r,n,o){this.log(0,t,r,n,o)}info(t,r,n,o){this.log(1,t,r,n,o)}warn(t,r,n,o){this.log(2,t,r,n,o)}error(t,r,n,o){this.log(3,t,r,n,o)}dataIn(t,r,n,o){this.info(t,`\u2192 ${r}`,n,o)}dataOut(t,r,n,o){this.info(t,`\u2190 ${r}`,n,o)}success(t,r,n,o){this.info(t,`\u2713 ${r}`,n,o)}failure(t,r,n,o){this.error(t,`\u2717 ${r}`,n,o)}timing(t,r,n,o){this.info(t,`\u23F1 ${r}`,o,{duration:`${n}ms`})}},c=new h;import p from"path";import{existsSync as d,readdirSync as tt}from"fs";import{homedir as M}from"os";import{spawnSync as C}from"child_process";var _={DEFAULT:5e3,HEALTH_CHECK:1e3,WORKER_STARTUP_WAIT:1e3,WORKER_STARTUP_RETRIES:15,WINDOWS_MULTIPLIER:1.5};function P(e){return process.platform==="win32"?Math.round(e*_.WINDOWS_MULTIPLIER):e}var u=p.join(M(),".claude","plugins","marketplaces","thedotmack"),T=p.join(M(),".claude","plugins","cache","thedotmack","claude-mem");function g(){try{if(!d(T))return null;let e=tt(T).filter(t=>/^\d+\.\d+\.\d+$/.test(t)).sort((t,r)=>{let[n,o,s]=t.split(".").map(Number),[i,a,f]=r.split(".").map(Number);return n!==i?i-n:o!==a?a-o:f-s});return e.length>0?p.join(T,e[0]):null}catch{return null}}function et(){let e=g();if(e){let n=p.join(e,"node_modules",".bin","pm2");if(d(n))return{command:n,cwd:e}}let t=p.join(u,"node_modules",".bin","pm2");return d(t)?{command:t,cwd:u}:C("which",["pm2"],{encoding:"utf-8",stdio:"pipe"}).status===0?{command:"pm2",cwd:u}:null}function x(){let e=g();if(e){let r=p.join(e,"scripts","worker-service.cjs");if(d(r))return{script:r,cwd:e}}let t=p.join(u,"plugin","scripts","worker-service.cjs");return d(t)?{script:t,cwd:u}:null}function b(){let e=g();if(e){let r=p.join(e,"ecosystem.config.cjs");if(d(r))return{configPath:r,cwd:e}}let t=p.join(u,"ecosystem.config.cjs");return d(t)?{configPath:t,cwd:u}:null}var rt=P(_.HEALTH_CHECK),nt=_.WORKER_STARTUP_WAIT,ot=_.WORKER_STARTUP_RETRIES;function S(){let e=p.join(M(),".claude-mem","settings.json"),t=m.loadFromFile(e);return parseInt(t.CLAUDE_MEM_WORKER_PORT,10)}async function A(){try{let e=S();return(await fetch(`http://127.0.0.1:${e}/health`,{signal:AbortSignal.timeout(rt)})).ok}catch(e){return c.debug("SYSTEM","Worker health check failed",{error:e instanceof Error?e.message:String(e),errorType:e?.constructor?.name}),!1}}async function st(){try{let e=x();if(!e)throw new Error("Worker script not found in cache or marketplace directory");let{script:t,cwd:r}=e;if(process.platform==="win32"){let n=t.replace(/'/g,"''"),o=r.replace(/'/g,"''"),s=C("powershell.exe",["-NoProfile","-NonInteractive","-Command",`Start-Process -FilePath 'node' -ArgumentList '${n}' -WorkingDirectory '${o}' -WindowStyle Hidden`],{cwd:r,stdio:"pipe",encoding:"utf-8",windowsHide:!0});if(s.status!==0)throw new Error(s.stderr||"PowerShell Start-Process failed")}else{let n=b();if(!n)throw new Error("Ecosystem config not found");let o=et();if(!o){let i=g();throw new Error(`PM2 not found. Install it locally with:
  cd ${i||u}
  npm install

Or install globally with: npm install -g pm2`)}let s=C(o.command,["start",n.configPath],{cwd:n.cwd,stdio:"pipe",encoding:"utf-8"});if(s.status!==0)throw new Error(s.stderr||"PM2 start failed")}for(let n=0;n<ot;n++)if(await new Promise(o=>setTimeout(o,nt)),await A())return!0;return!1}catch(e){let t=x();return c.error("SYSTEM","Failed to start worker",{platform:process.platform,workerScript:t?.script||"not found",error:e instanceof Error?e.message:String(e),cacheDir:g(),marketplaceRoot:u}),!1}}async function H(){if(await A())return;let e=await st();if(!(!e&&await A())&&!e){let t=S(),r=b(),n=r?.cwd||g()||u,o=r?.configPath||p.join(u,"ecosystem.config.cjs");throw new Error(`Worker service failed to start on port ${t}.

To start manually, run:
  cd ${n}
  npx pm2 start ${o}

If already running, try: npx pm2 restart claude-mem-worker`)}}import{appendFileSync as it}from"fs";import{homedir as at}from"os";import{join as ct}from"path";var lt=ct(at(),".claude-mem","silent.log");function v(e,t,r=""){let n=new Date().toISOString(),a=((new Error().stack||"").split(`
`)[2]||"").match(/at\s+(?:.*\s+)?\(?([^:]+):(\d+):(\d+)\)?/),f=a?`${a[1].split("/").pop()}:${a[2]}`:"unknown",l=`[${n}] [HAPPY-PATH-ERROR] [${f}] ${e}`;if(t!==void 0)try{l+=` ${JSON.stringify(t)}`}catch(E){l+=` [stringify error: ${E}]`}l+=`
`;try{it(lt,l)}catch(E){console.error("[silent-debug] Failed to write to log:",E)}return r}function $(e){throw e.cause?.code==="ECONNREFUSED"||e.name==="TimeoutError"||e.message?.includes("fetch failed")?new Error("There's a problem with the worker. If you just updated, type `pm2 restart claude-mem-worker` in your terminal to continue"):e}import{readFileSync as ut,existsSync as pt}from"fs";function L(e,t,r=!1){if(!e||!pt(e))return"";try{let n=ut(e,"utf-8").trim();if(!n)return"";let o=n.split(`
`);for(let s=o.length-1;s>=0;s--)try{let i=JSON.parse(o[s]);if(i.type===t&&i.message?.content){let a="",f=i.message.content;return typeof f=="string"?a=f:Array.isArray(f)&&(a=f.filter(l=>l.type==="text").map(l=>l.text).join(`
`)),r&&(a=a.replace(/<system-reminder>[\s\S]*?<\/system-reminder>/g,""),a=a.replace(/\n{3,}/g,`

`).trim()),a}}catch{continue}}catch(n){c.error("HOOK","Failed to read transcript",{transcriptPath:e},n)}return""}var y=["would you like","should i","do you want","shall i","what do you think","what would you prefer","how would you like","which option","which approach","let me know","please confirm","please let me know","can you clarify","could you clarify","can you provide","could you provide","what is your","what are your","is this what you","does this look","does this look correct","does this look right","does this seem correct","is that correct","is this correct","ready to proceed","want me to","like me to","prefer that i"],ft=["done","complete","completed","finished","successfully","all set","ready to use","implemented","created","updated","fixed","resolved","deployed","committed","pushed","merged","installed","configured"],K=["approve the edit","approve this edit","approve the change","approve this change","permission to write","permission to edit","permission to modify","permission to delete","permission to create","grant write permission","grant permission","need permission","need your permission","allow me to","allow this edit","allow this change","can i edit","can i write","can i modify","may i edit","may i write","may i modify"];function Et(e){let t=e.split(/(?<=[.!?])\s+/);for(let r=t.length-1;r>=0;r--){let n=t[r].trim();if(n.endsWith("?"))return n}for(let r=t.length-1;r>=Math.max(0,t.length-3);r--){let n=t[r].trim().toLowerCase();for(let o of y)if(n.includes(o))return t[r].trim()}return null}function W(e){if(!e||e.trim().length===0)return{isQuestion:!1,confidence:"high",extractedQuestion:null,reason:"Empty message"};let t=e.toLowerCase();for(let a of K)if(t.includes(a))return{isQuestion:!1,confidence:"high",extractedQuestion:null,reason:`Permission/tool prompt detected: "${a}" - should be answered locally`};let n=(e.split(`

`).pop()||e).toLowerCase(),o=0;for(let a of ft)n.includes(a)&&o++;let s=0,i=Et(e);e.trim().endsWith("?")&&(s+=3);for(let a of y)t.includes(a)&&s++;return s>=3&&o===0?{isQuestion:!0,confidence:"high",extractedQuestion:i,reason:"Message ends with question mark and contains question phrases"}:s>=2&&o<=1?{isQuestion:!0,confidence:"medium",extractedQuestion:i,reason:"Message contains multiple question indicators"}:s>=1&&o===0?{isQuestion:!0,confidence:"low",extractedQuestion:i,reason:"Message contains question indicator without completion phrases"}:o>=2?{isQuestion:!1,confidence:"high",extractedQuestion:null,reason:"Message contains completion phrases indicating task is done"}:{isQuestion:!1,confidence:"medium",extractedQuestion:null,reason:"No clear question indicators found"}}function F(e){if(!e)return!1;let t=e.toLowerCase();for(let r of K.slice(0,5))if(t.includes(r))return!1;if(e.trim().endsWith("?"))return!0;for(let r of y.slice(0,10))if(t.includes(r))return!0;return!1}async function _t(e){if(await H(),!e)throw new Error("summaryHook requires input");let{session_id:t}=e,r=S(),n=v("Missing transcript_path in Stop hook input",{session_id:t},e.transcript_path||""),o=L(n,"user"),s=L(n,"assistant",!0);if(c.dataIn("HOOK","Stop: Requesting summary",{workerPort:r,hasLastUserMessage:!!o,hasLastAssistantMessage:!!s}),s&&F(s)){let i=W(s);i.isQuestion&&i.confidence!=="low"&&(c.info("HOOK","Question detected, notifying worker",{confidence:i.confidence,hasExtractedQuestion:!!i.extractedQuestion}),fetch(`http://127.0.0.1:${r}/api/sessions/waiting`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({claudeSessionId:t,project:e.cwd.split("/").pop()||"unknown",cwd:e.cwd,question:i.extractedQuestion,fullMessage:s,transcriptPath:n}),signal:AbortSignal.timeout(5e3)}).catch(a=>{c.warn("HOOK","Failed to notify waiting session",{error:a.message})}))}try{let i=await fetch(`http://127.0.0.1:${r}/api/sessions/summarize`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({claudeSessionId:t,last_user_message:o,last_assistant_message:s}),signal:AbortSignal.timeout(_.DEFAULT)});if(!i.ok){let a=await i.text();throw c.failure("HOOK","Failed to generate summary",{status:i.status},a),new Error(`Failed to request summary from worker: ${i.status} ${a}`)}c.debug("HOOK","Summary request sent successfully")}catch(i){$(i)}finally{try{let i=await fetch(`http://127.0.0.1:${r}/api/processing`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({isProcessing:!1}),signal:AbortSignal.timeout(2e3)});i.ok||c.warn("HOOK","Failed to stop spinner",{status:i.status})}catch(i){c.warn("HOOK","Could not stop spinner",{error:i.message})}}console.log(U("Stop",!0))}var w="";j.on("data",e=>w+=e);j.on("end",async()=>{let e=w?JSON.parse(w):void 0;await _t(e)});
